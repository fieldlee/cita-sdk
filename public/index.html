
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Jekyll v4.0.1">
    <title>欧冶区块链演示界面</title>

 <!-- CSS only -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

<!-- JS, Popper.js, and jQuery -->
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script> -->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
<script src="notify.js"></script>
<meta name="theme-color" content="#563d7c">
    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

    </style>

  </head>
  <body>
    <div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
  <h5 class="my-0 mr-md-auto font-weight-normal">欧冶区块链演示界面</h5>
  <nav class="my-2 my-md-0 mr-md-3">
    <a class="p-2 text-dark" href="#">账号生成</a>
    <a class="p-2 text-dark" href="#">权限设置</a>
    <a class="p-2 text-dark" href="#">存证</a>
    <a class="p-2 text-dark" href="#">取证</a>
  </nav>
</div>

<div class="container">
    <div class="row card-deck">
        <div class="card  shadow-sm">
            <div class="card-header">
                <h4 class="my-0 font-weight-normal">账号生成</h4>
              </div>
              <div class="card-body">
                <label for="address">地址</label>
                <input type="text" class="form-control" id="address" placeholder="" value="" required>
                <label for="prikey">私钥</label>
                <input type="text" class="form-control" id="prikey" placeholder="" value="" required>
                <label for="btnaccount"></label>
                <button type="button" id="btnaccount" onclick="getAddress()" class="col-sm-4 col-md-2 btn btn-lg btn-block btn-outline-primary">生成账号</button>
              </div>
        </div>
    </div>
  
    <div class="row card-deck">
        <div class="card  shadow-sm">
            <div class="card-header">
                <h4 class="my-0 font-weight-normal">权限设置</h4>
              </div>
              <div class="card-body">
                <div class="row">
                    <div class="col-md-8 mb-8">
                        <label for="txpermission">交易权限</label>
                        <input type="text" class="form-control" id="txpermission" placeholder="" value="" required>
                    </div>
                    <div class="col-md-4 mb-4">
                        <label id="txpermissionhash"></label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8 mb-8">
                        <label for="contractpermission">发布合约权限</label>
                        <input type="text" class="form-control" id="contractpermission" placeholder="" value="" required>
                    </div>
                    <div class="col-md-4 mb-4">
                        <label id="contractpermissionhash"></label>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-6">
                        <button type="button" id="btntxpremission" onclick="setPremission('tx')" class="col-sm-4 col-md-4 btn btn-lg btn-block btn-outline-primary">交易权限设置</button>
                    </div>
                    <div class="col-md-6 mb-6">
                        <button type="button" id="btncontractpremission" onclick="setPremission('contract')" class="col-sm-4 col-md-4 btn btn-lg btn-block btn-outline-primary">合约权限设置</button>
                    </div>
                </div>
              </div>
        </div>
    </div>
    <div class="row card-deck">
        <div class="card  shadow-sm">
            <div class="card-header">
                <h4 class="my-0 font-weight-normal">存证</h4>
              </div>
              <div class="card-body">
                <label for="id_number">流水号</label>
                <input type="text" class="form-control" id="id_number" placeholder="" value="" required>
                
                <div class="row">
                    <div class="col-md-6 mb-6">
                        <label for="in_date">入厂时间</label>
                        <input  type="text" class="form-control" id="in_date" placeholder="" value="2020-06-09 10:30" required>
                      
                    </div>
                    <div class="col-md-6 mb-6">
                        <label for="in_cert">车牌</label>
                        <input  type="text" class="form-control" id="in_cert" placeholder="" value="" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-6">
                        <label for="in_lvl">质量等级</label>
                        <input  type="text" class="form-control" id="in_lvl" placeholder="" value="" required>
                      
                    </div>
                    <div class="col-md-6 mb-6">
                        <label for="in_weight">重车重量</label>
                        <input  type="text" class="form-control" id="in_weight" placeholder="" value="" required>
                    </div>
                </div>
                <label for="in_pic">照片hash</label>
               
                <div class="input-group">
                    <input type="text" class="form-control"  id="in_pic" placeholder="">
                    <span class="input-group-btn">
                      <button class="btn btn-default" onclick="sethash('in')" type="button">生成照片hash</button>
                    </span>
                </div>
                <label for="btnsetinfo"></label>
                <button type="button" id="btnsetinfo" onclick="setEntry()" class="col-sm-4 col-md-2 btn btn-lg btn-block btn-outline-primary">入厂存证</button>
              

                <div class="row">
                    <div class="col-md-6 mb-6">
                        <label for="out_date">出厂时间</label>
                        <input  type="text" class="form-control" id="out_date" placeholder="" value="2020-06-09 12:30" required>
                    </div>
                    <div class="col-md-6 mb-6">
                        <label for="out_weight">空车重量</label>
                        <input  type="text" class="form-control" id="out_weight" placeholder="" value="" required>
                    </div>
                </div>
                <label for="out_pic">出厂照片hash</label>
               
                <div class="input-group">
                    <input type="text" class="form-control"  id="out_pic" placeholder="">
                    <span class="input-group-btn">
                      <button class="btn btn-default" onclick="sethash('out')" type="button">生成照片hash</button>
                    </span>
                </div>
                <label for="btnsetinfo"></label>
                <button type="button" id="btnsetinfo" onclick="setOut()" class="col-sm-4 col-md-2 btn btn-lg btn-block btn-outline-primary">出厂存证</button>
              </div>
        </div>
    </div>
    <div class="row card-deck">
        <div class="card  shadow-sm">
            <div class="card-header">
                <h4 class="my-0 font-weight-normal">取证</h4>
              </div>
              <div class="card-body">
                <label for="result">取证结果</label>
                <textarea class="form-control" id="result" rows="8" ></textarea>
                <label for="btngetinfo"></label>
                <button type="button" id="btngetinfo" onclick="getInfo()" class="col-sm-4 col-md-2 btn btn-lg btn-block btn-outline-primary">取证</button>
              </div>
        </div>
    </div>
    
</div>

  <footer class="pt-4 my-md-5 pt-md-5 border-top">
    <div class="row">
      <div class="col-12 col-md">
        <small class="d-block mb-3 text-muted">&copy; 2020-2020</small>
      </div>
      
  </footer>
</div>
</body>
<script type="text/javascript">
    $(function(){
        $("#id_number").val(_getRandomString(12));
    });
    function sethash(v){
        if(v=="in"){
            $("#in_pic").val(SHA256($("#id_number").val()+$("#in_date").val()));
        }else{
            $("#out_pic").val(SHA256($("#id_number").val()+$("#out_date").val()));
        }
    }
    function _getRandomString(len) {
        len = len || 32;
        var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678'; // 默认去掉了容易混淆的字符oOLl,9gq,Vv,Uu,I1
        var maxPos = $chars.length;
        var pwd = '';
        for (i = 0; i < len; i++) {
            pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
        }
        return pwd;
    }
    function getAddress(){
        $.ajax({
            type: "POST",
            url: "/personal/create",            
            dataType: "json",
            data:{
                "password":"password"
            },
            success: function (msg) {
                console.log(msg);
                $("#address").val(msg.address);
                $("#prikey").val(msg.privateKey);
            },
            error: function () {
                alert("错误");
            }
        });
    }
    function setEntry(){
        $.ajax({
            type: "POST",
            url: "/demo/entryfactory",            
            dataType: "json",
            data:{
                "id":$("#id_number").val(),
                "date":$("#in_date").val(),
                "cert":$("#in_cert").val(),
                "level":$("#in_lvl").val(),
                "entryhash":$("#in_pic").val(),
                "weight":$("#in_weight").val(),
                "from":"",
                "privatekey":""
            },
            success: function (msg) {
                console.log(msg);
                var hash = msg.listener.transactionHash;
                $.notify({
                  title: "上链完成:",
                  message: "交易Hash:"+hash
                });
            },
            error: function () {
                alert("错误");
            }
        });
    }

    function setOut(){
        $.ajax({
            type: "POST",
            url: "/demo/outfactory",            
            dataType: "json",
            data:{
                "id":$("#id_number").val(),
                "date":$("#out_date").val(),
                "outhash":$("#out_pic").val(),
                "weight":$("#out_weight").val(),
                "from":"",
                "privatekey":""
            },
            success: function (msg) {
                console.log(msg);
                var hash = msg.listener.transactionHash;
                $.notify({
                  title: "上链完成:",
                  message: "交易Hash:"+hash
                });
            },
            error: function () {
                alert("错误");
            }
        });
    }
    function getInfo(){
        $.ajax({
            type: "POST",
            url: "/demo/getinfo",            
            dataType: "json",
            data:{
                "id":$("#id_number").val()
            },
            success: function (msg) {
                console.log(msg);
                $("#result").val(JSON.stringify(msg));
            },
            error: function () {
                alert("错误");
            }
        });
    }

    function setPremission(v){
        if (v == "tx") {
            if ($("#txpermission").val() == "") {
                return;
            }
            $.ajax({
            type: "POST",
            url: "/sys/permissiontx",            
            dataType: "json",
            data:{
                "address":$("#txpermission").val()
            },
            success: function (msg) {
                console.log(msg);
                // $("#txpermissionhash").hidden=false;
                $("#txpermissionhash").text(JSON.stringify(msg));
            },
            error: function () {
                alert("错误");
            }
            });
        }else{
            if ($("#contractpermission").val() == "") {
                return;
            }
            $.ajax({
            type: "POST",
            url: "/sys/permissioncontract",            
            dataType: "json",
            data:{
                "address":$("#contractpermission").val()
            },
            success: function (msg) {
                console.log(msg);
                // $("#contractpermissionhash").hidden=false;
                $("#contractpermissionhash").text(JSON.stringify(msg));
            },
            error: function () {
                alert("错误");
            }
            });
        }
        
    }
    
    function SHA256(s){
      var chrsz = 8;
      var hexcase = 0;
      function safe_add (x, y) {
        var lsw = (x & 0xFFFF) + (y & 0xFFFF);
        var msw = (x >> 16) + (y >> 16) + (lsw >> 16);
        return (msw << 16) | (lsw & 0xFFFF);
      }
      function S (X, n) { return ( X >>> n ) | (X << (32 - n)); }
      function R (X, n) { return ( X >>> n ); }
      function Ch(x, y, z) { return ((x & y) ^ ((~x) & z)); }
      function Maj(x, y, z) { return ((x & y) ^ (x & z) ^ (y & z)); }
      function Sigma0256(x) { return (S(x, 2) ^ S(x, 13) ^ S(x, 22)); }
      function Sigma1256(x) { return (S(x, 6) ^ S(x, 11) ^ S(x, 25)); }
      function Gamma0256(x) { return (S(x, 7) ^ S(x, 18) ^ R(x, 3)); }
      function Gamma1256(x) { return (S(x, 17) ^ S(x, 19) ^ R(x, 10)); }
      function core_sha256 (m, l) {
        var K = new Array(0x428A2F98, 0x71374491, 0xB5C0FBCF, 0xE9B5DBA5, 0x3956C25B, 0x59F111F1, 0x923F82A4, 0xAB1C5ED5, 0xD807AA98, 0x12835B01, 0x243185BE, 0x550C7DC3, 0x72BE5D74, 0x80DEB1FE, 0x9BDC06A7, 0xC19BF174, 0xE49B69C1, 0xEFBE4786, 0xFC19DC6, 0x240CA1CC, 0x2DE92C6F, 0x4A7484AA, 0x5CB0A9DC, 0x76F988DA, 0x983E5152, 0xA831C66D, 0xB00327C8, 0xBF597FC7, 0xC6E00BF3, 0xD5A79147, 0x6CA6351, 0x14292967, 0x27B70A85, 0x2E1B2138, 0x4D2C6DFC, 0x53380D13, 0x650A7354, 0x766A0ABB, 0x81C2C92E, 0x92722C85, 0xA2BFE8A1, 0xA81A664B, 0xC24B8B70, 0xC76C51A3, 0xD192E819, 0xD6990624, 0xF40E3585, 0x106AA070, 0x19A4C116, 0x1E376C08, 0x2748774C, 0x34B0BCB5, 0x391C0CB3, 0x4ED8AA4A, 0x5B9CCA4F, 0x682E6FF3, 0x748F82EE, 0x78A5636F, 0x84C87814, 0x8CC70208, 0x90BEFFFA, 0xA4506CEB, 0xBEF9A3F7, 0xC67178F2);
        var HASH = new Array(0x6A09E667, 0xBB67AE85, 0x3C6EF372, 0xA54FF53A, 0x510E527F, 0x9B05688C, 0x1F83D9AB, 0x5BE0CD19);
        var W = new Array(64);
        var a, b, c, d, e, f, g, h, i, j;
        var T1, T2;
        m[l >> 5] |= 0x80 << (24 - l % 32);
        m[((l + 64 >> 9) << 4) + 15] = l;
        for ( var i = 0; i<m.length; i+=16 ) {
          a = HASH[0];
          b = HASH[1];
          c = HASH[2];
          d = HASH[3];
          e = HASH[4];
          f = HASH[5];
          g = HASH[6];
          h = HASH[7];
          for ( var j = 0; j<64; j++) {
            if (j < 16) W[j] = m[j + i];
            else W[j] = safe_add(safe_add(safe_add(Gamma1256(W[j - 2]), W[j - 7]), Gamma0256(W[j - 15])), W[j - 16]);
            T1 = safe_add(safe_add(safe_add(safe_add(h, Sigma1256(e)), Ch(e, f, g)), K[j]), W[j]);
            T2 = safe_add(Sigma0256(a), Maj(a, b, c));
            h = g;
            g = f;
            f = e;
            e = safe_add(d, T1);
            d = c;
            c = b;
            b = a;
            a = safe_add(T1, T2);
          }
          HASH[0] = safe_add(a, HASH[0]);
          HASH[1] = safe_add(b, HASH[1]);
          HASH[2] = safe_add(c, HASH[2]);
          HASH[3] = safe_add(d, HASH[3]);
          HASH[4] = safe_add(e, HASH[4]);
          HASH[5] = safe_add(f, HASH[5]);
          HASH[6] = safe_add(g, HASH[6]);
          HASH[7] = safe_add(h, HASH[7]);
        }
        return HASH;
      }
      function str2binb (str) {
        var bin = Array();
        var mask = (1 << chrsz) - 1;
        for(var i = 0; i < str.length * chrsz; i += chrsz) {
          bin[i>>5] |= (str.charCodeAt(i / chrsz) & mask) << (24 - i%32);
        }
        return bin;
      }
      function Utf8Encode(string) {
        string = string.replace(/\r\n/g,"\n");
        var utftext = "";
        for (var n = 0; n < string.length; n++) {
          var c = string.charCodeAt(n);
          if (c < 128) {
            utftext += String.fromCharCode(c);
          }
          else if((c > 127) && (c < 2048)) {
            utftext += String.fromCharCode((c >> 6) | 192);
            utftext += String.fromCharCode((c & 63) | 128);
          }
          else {
            utftext += String.fromCharCode((c >> 12) | 224);
            utftext += String.fromCharCode(((c >> 6) & 63) | 128);
            utftext += String.fromCharCode((c & 63) | 128);
          }
        }
        return utftext;
      }
      function binb2hex (binarray) {
        var hex_tab = hexcase ? "0123456789ABCDEF" : "0123456789abcdef";
        var str = "";
        for(var i = 0; i < binarray.length * 4; i++) {
          str += hex_tab.charAt((binarray[i>>2] >> ((3 - i%4)*8+4)) & 0xF) +
          hex_tab.charAt((binarray[i>>2] >> ((3 - i%4)*8 )) & 0xF);
        }
        return str;
      }
      s = Utf8Encode(s);
      return binb2hex(core_sha256(str2binb(s), s.length * chrsz));
}
</script>
</html>
